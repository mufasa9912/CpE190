#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <bcm2835.h>
#include <unistd.h>
#include <sched.h>
#include <sys/mman.h>

//#define MCP4822DAC 0b0001
#define LDAC   RPI_V2_GPIO_P1_32
#define SCLK   1000000

char dac1khz[200] = {0x18,0x00,0x18,0x80,0x19,0x00,0x19,0x7f,0x19,0xfd,0x1a,0x78,0x1a,0xf1,0x1b,0x67,0x1b,0xda,0x1c,0x49,0x1c,0xb3,0x1d,0x19,0x1d,0x79,0x1d,0xd4,0x1e,0x29,0x1e,0x78,0x1e,0xc0,0x1f,0x02,0x1f,0x3c,0x1f,0x6f,0x1f,0x9b,0x1f,0xbf,0x1f,0xdb,0x1f,0xef,0x1f,0xfb,0x1f,0xff,0x1f,0xfb,0x1f,0xef,0x1f,0xdb,0x1f,0xbf,0x1f,0x9b,0x1f,0x6f,0x1f,0x3c,0x1f,0x02,0x1e,0xc0,0x1e,0x78,0x1e,0x29,0x1d,0xd4,0x1d,0x79,0x1d,0x19,0x1c,0xb3,0x1c,0x49,0x1b,0xda,0x1b,0x67,0x1a,0xf1,0x1a,0x78,0x19,0xfd,0x19,0x7f,0x19,0x00,0x18,0x80,0x18,0x00,0x17,0x7f,0x16,0xff,0x16,0x80,0x16,0x02,0x15,0x87,0x15,0x0e,0x14,0x98,0x14,0x25,0x13,0xb6,0x13,0x4c,0x12,0xe6,0x12,0x86,0x12,0x2b,0x11,0xd6,0x11,0x87,0x11,0x3f,0x01,0xfd,0x01,0xc3,0x01,0x90,0x01,0x64,0x01,0x40,0x01,0x24,0x01,0x10,0x00,0x14,0x00,0x10,0x00,0x14,0x01,0x10,0x01,0x24,0x01,0x40,0x01,0x64,0x01,0x90,0x01,0xc3,0x01,0xfd,0x11,0x3f,0x11,0x87,0x11,0xd6,0x12,0x2b,0x12,0x86,0x12,0xe6,0x13,0x4c,0x13,0xb6,0x14,0x25,0x14,0x98,0x15,0x0e,0x15,0x87,0x16,0x02,0x16,0x80,0x16,0xff,0x17,0x7f};
uint16_t dac900hz[111] = {0x800, 0x873, 0x8e7, 0x95a, 0x9cb, 0xa3b, 0xaaa, 0xb16, 0xb7f, 0xbe6, 0xc4a, 0xcaa, 0xd06, 0xd5e, 0xdb2, 0xe01, 0xe4b, 0xe8f, 0xecf, 0xf09, 0xf3d, 0xf6b, 0xf94, 0xfb5, 0xfd1, 0xfe6, 0xff5, 0xffd, 0xfff, 0xffa, 0xfee, 0xfdc, 0xfc4, 0xfa5, 0xf80, 0xf55, 0xf24, 0xeed, 0xeb0, 0xe6e, 0xe26, 0xdda, 0xd88, 0xd32, 0xcd8, 0xc7a, 0xc18, 0xbb3, 0xb4b, 0xae0, 0xa73, 0xa03, 0x992, 0x920, 0x8ad, 0x839, 0x7c6, 0x752, 0x6df, 0x66d, 0x5fc, 0x58c, 0x51f, 0x4b4, 0x44c, 0x3e7, 0x385, 0x327, 0x2cd, 0x277, 0x225, 0x1d9, 0x191, 0x14f, 0x112, 0xdb, 0xaa, 0x7f, 0x5a, 0x3b, 0x23, 0x11, 0x5, 0x0, 0x2, 0xa, 0x19, 0x2e, 0x4a, 0x6b, 0x94, 0xc2, 0xf6, 0x130, 0x170, 0x1b4, 0x1fe, 0x24d, 0x2a1, 0x2f9, 0x355, 0x3b5, 0x419, 0x480, 0x4e9, 0x555, 0x5c4, 0x634, 0x6a5, 0x718, 0x78c};
uint16_t dac800hz[125] = {0x800, 0x866, 0x8cd, 0x933, 0x998, 0x9fd, 0xa60, 0xac1, 0xb21, 0xb7e, 0xbda, 0xc33, 0xc89, 0xcdc, 0xd2c, 0xd79, 0xdc2, 0xe08, 0xe49, 0xe87, 0xec0, 0xef5, 0xf26, 0xf51, 0xf79, 0xf9b, 0xfb8, 0xfd0, 0xfe4, 0xff2, 0xffb, 0xfff, 0xffe, 0xff7, 0xfeb, 0xfdb, 0xfc5, 0xfaa, 0xf8a, 0xf66, 0xf3c, 0xf0e, 0xedb, 0xea4, 0xe69, 0xe29, 0xde6, 0xd9e, 0xd53, 0xd05, 0xcb3, 0xc5e, 0xc07, 0xbac, 0xb50, 0xaf1, 0xa91, 0xa2e, 0x9cb, 0x966, 0x900, 0x89a, 0x833, 0x7cc, 0x765, 0x6ff, 0x699, 0x634, 0x5d1, 0x56e, 0x50e, 0x4af, 0x453, 0x3f8, 0x3a1, 0x34c, 0x2fa, 0x2ac, 0x261, 0x219, 0x1d6, 0x196, 0x15b, 0x124, 0xf1, 0xc3, 0x99, 0x75, 0x55, 0x3a, 0x24, 0x14, 0x8, 0x1, 0x0, 0x4, 0xd, 0x1b, 0x2f, 0x47, 0x64, 0x86, 0xae, 0xd9, 0x10a, 0x13f, 0x178, 0x1b6, 0x1f7, 0x23d, 0x286, 0x2d3, 0x323, 0x376, 0x3cc, 0x425, 0x481, 0x4de, 0x53e, 0x59f, 0x602, 0x667, 0x6cc, 0x732, 0x799};
uint16_t dac700hz[143] = {0x800,0x859,0x8b3,0x90d,0x966,0x9be,0xa15,0xa6b,0xac0,0xb14,0xb66,0xbb7,0xc06,0xc52,0xc9d,0xce5,0xd2b,0xd6f,0xdaf,0xded,0xe28,0xe60,0xe95,0xec6,0xef4,0xf1f,0xf46,0xf6a,0xf89,0xfa6,0xfbe,0xfd3,0xfe3,0xff0,0xff9,0xffe,0xfff,0xffc,0xff5,0xfea,0xfdb,0xfc9,0xfb2,0xf98,0xf7a,0xf58,0xf33,0xf0a,0xede,0xeae,0xe7b,0xe44,0xe0b,0xdcf,0xd8f,0xd4d,0xd09,0xcc2,0xc78,0xc2c,0xbdf,0xb8f,0xb3e,0xaeb,0xa96,0xa40,0x9e9,0x992,0x939,0x8e0,0x886,0x82c,0x7d3,0x779,0x71f,0x6c6,0x66d,0x616,0x5bf,0x569,0x514,0x4c1,0x470,0x420,0x3d3,0x387,0x33d,0x2f6,0x2b2,0x270,0x230,0x1f4,0x1bb,0x184,0x151,0x121,0xf5,0xcc,0xa7,0x85,0x67,0x4d,0x36,0x24,0x15,0xa,0x3,0x0,0x1,0x6,0xf,0x1c,0x2c,0x41,0x59,0x76,0x95,0xb9,0xe0,0x10b,0x139,0x16a,0x19f,0x1d7,0x212,0x250,0x290,0x2d4,0x31a,0x362,0x3ad,0x3f9,0x448,0x499,0x4eb,0x53f,0x594,0x5ea,0x641,0x699,0x6f2,0x74c,0x7a6};
uint16_t dac600hz[167] = {0x800,0x84d,0x899,0x8e6,0x932,0x97e,0x9ca,0xa15,0xa5f,0xaa8,0xaf0,0xb37,0xb7d,0xbc1,0xc05,0xc47,0xc87,0xcc6,0xd03,0xd3e,0xd77,0xdae,0xde3,0xe16,0xe47,0xe76,0xea2,0xecc,0xef3,0xf18,0xf3a,0xf5a,0xf77,0xf91,0xfa9,0xfbd,0xfcf,0xfde,0xfeb,0xff4,0xffb,0xffe,0xfff,0xffd,0xff8,0xff0,0xfe5,0xfd7,0xfc7,0xfb3,0xf9d,0xf84,0xf69,0xf4a,0xf29,0xf06,0xee0,0xeb7,0xe8c,0xe5f,0xe2f,0xdfd,0xdc9,0xd93,0xd5a,0xd20,0xce4,0xca6,0xc67,0xc26,0xbe3,0xb9f,0xb5a,0xb13,0xacc,0xa83,0xa3a,0x9ef,0x9a4,0x959,0x90c,0x8c0,0x873,0x826,0x7d9,0x78c,0x73f,0x6f3,0x6a6,0x65b,0x610,0x5c5,0x57c,0x533,0x4ec,0x4a5,0x460,0x41c,0x3d9,0x398,0x359,0x31b,0x2df,0x2a5,0x26c,0x236,0x202,0x1d0,0x1a0,0x173,0x148,0x11f,0xf9,0xd6,0xb5,0x96,0x7b,0x62,0x4c,0x38,0x28,0x1a,0xf,0x7,0x2,0x0,0x1,0x4,0xb,0x14,0x21,0x30,0x42,0x56,0x6e,0x88,0xa5,0xc5,0xe7,0x10c,0x133,0x15d,0x189,0x1b8,0x1e9,0x21c,0x251,0x288,0x2c1,0x2fc,0x339,0x378,0x3b8,0x3fa,0x43e,0x482,0x4c8,0x50f,0x557,0x5a0,0x5ea,0x635,0x681,0x6cd,0x719,0x766,0x7b2};
char dac500hz[40] = {0x18,0x00,0x1a,0x78,0x1c,0xb3,0x1e,0x78,0x1f,0x9b,0x1f,0xff,0x1f,0x9b,0x1e,0x78,0x1c,0xb3,0x1a,0x78,0x18,0x00,0x15,0x87,0x13,0x4c,0x11,0x87,0x10,0x64,0x10,0x00,0x10,0x64,0x11,0x87,0x13,0x4c,0x15,0x87};
char dac100hz[20] = {0x18,0x00,0x1c,0xb3,0x1f,0x9b,0x1f,0x9b,0x1c,0xb3,0x18,0x00,0x13,0x4c,0x10,0x64,0x10,0x64,0x13,0x4c};
// uint8_t spiOut[2];
// uint16_t word;

int speakerInit() {
    printf("\nInitializing library and SPI\n");
    // initilize the library
    if (!bcm2835_init())
    {
        printf("bcm2835_init failed. Are you running as root??\n");
        return 1;
    }

    // begin the SPI
    if (!bcm2835_spi_begin())
    {
        printf("bcm2835_spi_begin failed. Are you running as root??\n");
        return 1;
    }

    //Set the bit order
    bcm2835_spi_setBitOrder(BCM2835_SPI_BIT_ORDER_MSBFIRST);
    //Set the data mode (the DAC we have can do either mode 0 or mode 3)
    bcm2835_spi_setDataMode(BCM2835_SPI_MODE0);
    //Set the SPI cock divider
    bcm2835_spi_set_speed_hz(SCLK);
    //Set the chip select
    bcm2835_spi_chipSelect(BCM2835_SPI_CS0);
    //Set the chip select polarity
    bcm2835_spi_setChipSelectPolarity(BCM2835_SPI_CS0, LOW);
    
    printf("Finished Initilizing library and SPI\n");
    return 0;
} 

int main(int argc, char **argv)
{
    int size = 0;
    int i;
    uint64_t start;
    char tmp[2];

    // this part will set this program as high priority and will stop it from being paged out
    // should help decrease os overhead for more acurate delay timing
    printf("Init realtime environment\n");
    if (geteuid() == 0) {
        struct sched_param sp;
        memset(&sp, 0, sizeof(sp));
        sp.sched_priority = sched_get_priority_max(SCHED_FIFO);
        sched_setscheduler(0, SCHED_FIFO, &sp);
        mlockall(MCL_CURRENT | MCL_FUTURE);
        fprintf(stderr, "Running with realtime priority!\n");
    } else {
        fprintf(stderr, "Not running with realtime priority.\n");
    }

    // initilize library and SPI
    printf("right before speaker INIT");
    if (speakerInit()) {
        printf("fialed to initilize library and SPI");
    } else {
        printf("Library and SPI are ready");
    }
    // setup LDAC pin as an output
    printf("setting up LDAC pin");
    bcm2835_gpio_fsel(LDAC, BCM2835_GPIO_FSEL_OUTP);
    // set LDAC pin to low (output will latch on to register contents on the rising edge of the CS pin)
    printf("setting LDAC to low");
    bcm2835_gpio_clr(LDAC);
    // pick a frequency to output
    //outputFreq = *dac1khz;
    // loop through the whole array and update to use the correct instructions (most significant 4 bits)
    size = 200;
    //for(i = 0; i < 100; i++) {
        //outputFeq
    
    //size = sizeof outputFreq / sizeof &outputFreq;
    /*
    for(i = 0; i < 100; i++) {
        dac1khz[i] = 0x1000 | dac1khz[i];
    }*/

    while(1) {
        // infinitly loop through array and output to dac every 10 us (100Khz frequency of outputing)
        for(i = 0; i < size; i = i+2) {
            start = bcm2835_st_read();
            tmp[0] = dac1khz[i];
            tmp[1] = dac1khz[i+1];
            bcm2835_spi_transfern(tmp, 2);
            //speakerOut((char *)outputFreq[i]);
            //printf("entering delay for 100 us");
            bcm2835_st_delay(start, 10);
        }
    }
    return 0;
}
